% !TEX root =  ../main.tex 

\section{Personalized schedules for repeat biopsies}
\label{sec : pers_sched_approaches}
Once a joint model for GR and PSA levels is obtained, the next step is to use it to create personalized schedules for biopsies. To elucidate the scheduling methods, let us assume that a personalized schedule is to be created for a new patient enumerated $j$, who is not present in the original sample of patients $\mathcal{D}_n$. Further let us assume that this patient did not have a GR at his last biopsy performed at time $t$, and that the PSA levels are available up to a time point $s$. The goal is to find the optimal time $u \geq \text{max}(t,s)$ of the next biopsy.

%Let us assume that we have a new patient $j$ enrolled in an AS program and let $T_j^*$ denote the actual time of GR for this patient. Let the schedule of biopsies for this patient be given by $\{T^b_{j0}, T^b_{j1}, \ldots, T^b_{j{N_j^b}}\}$, where $T^b_{j{N_j^b}}$ is the time at which GR is detected and $N_j^b$ is the number of biopsies conducted until that time. Because of the periodical nature of biopsy schedules, we never observe the exact time $T_j^*$ of GR. Instead we only observe the interval in which it falls, i.e. $T^*_j \epsilon (T^b_{j{N_j^b - 1}}, T^b_{j{N_j^b}}]$. In this context, the most useful biopsy schedule for a patient will be the one with the least number of biopsies $N_j^b$ and the smallest offset $O_j = T^b_{j{N_j^b}} - T_j^*$ possible. 

\subsection{Posterior predictive distribution for time to GR}
\label{subsec : ppd_time_to_GR}
Let $\mathcal{Y}_j(s)$ denote the history of PSA levels taken up to time $s$ for patient $j$. The information from PSA history and repeat biopsies is manifested by the posterior predictive distribution $g(T^*_j)$, given by (conditioning on baseline covariates $\boldsymbol{w}_i$ is dropped for notational simplicity hereafter):
\begin{equation}
\label{eq : dyn_dist_fail_time}
\begin{split}
g(T^*_j) &= p\big(T^*_j \mid T^*_j > t, \mathcal{Y}_j(s), \mathcal{D}_n\big)\\
&= \int p\big(T^*_j \mid T^*_j > t, \mathcal{Y}_j(s), \boldsymbol{\theta}\big) p\big(\boldsymbol{\theta} \mid \mathcal{D}_n\big) \diff \boldsymbol{\theta}\\
&= \int \int p\big(T^*_j \mid T^*_j > t, \boldsymbol{b_j}, \boldsymbol{\theta}\big) p\big(\boldsymbol{b}_j \mid T^*_j>t, \mathcal{Y}_j(s), \boldsymbol{\theta}\big)p\big(\boldsymbol{\theta} \mid \mathcal{D}_n\big) \diff \boldsymbol{b}_j \diff \boldsymbol{\theta}
\end{split}
\end{equation}
The posterior predictive distribution depends on the observed longitudinal history via the random effects $\boldsymbol{b_j}$. The posterior distribution of the parameters $\boldsymbol{\theta}$, denoted by $p(\boldsymbol{\theta} \mid \mathcal{D}_n)$ is obtained as in Section \ref{subsec : jm_param_estimation_bayesian}.

\subsection{Loss functions}
\label{subsec : loss_functions}
To find the time $u$ of next biopsy, we use principles from statistical decision theory in a Bayesian setting \citep{bergerDecisionTheory,robertBayesianChoice}. More specifically, we propose to choose future biopsy time $u$ by minimizing the posterior expected loss $E_g\big[L\{T^*_j, u\}\big]$, where the expectation is taken w.r.t. the posterior predictive distribution $g(T^*_j)$. 
\begin{equation*}
E_g\big[L\{T^*_j, u\}\big] = \int_t^\infty L\{T^*_j, u\} p\big(T^*_j \mid T^*_j > t, \mathcal{Y}_j(s), \mathcal{D}_n\big) \diff T^*_j
\end{equation*}
Various loss functions $L\{T^*_j, u\}$ have been proposed in literature \citep{robertBayesianChoice}. The ones we utilize, and the corresponding motivations are presented next.

\subsubsection{Expected and median time of GR}
\label{subsubsec : exp_median_fail_time}
One of the reasons, patients did not comply with the existing PRIAS schedule was \textquoteleft complications on a previous biopsy \textquoteright. Therefore, it makes sense to have as less biopsies as possible. In the ideal case only 1 biopsy, performed at the exact time of GR is sufficient. Hence, neither a time which overshoots the true GR time $T^*_j$, nor a time which undershoots is preferred. In this regard, the squared loss function $L\{T^*_j, u\} = (T^*_j - u)^2$ and absolute loss function $L\{T^*_j, u\} = \abs{T^*_j - u}$ have the properties that the posterior expected loss is symmetric on both sides of $T^*_j$. Secondly, both loss functions have well known solutions available. The posterior expected loss for the squared loss function is given by:
\begin{equation}
\label{eq : posterior_squared_loss}
\begin{split}
E_g\big[L\{T^*_j, u\}\big] &= E_g\big[\{T^*_j - u\}^2\big]\\
&=E_g\big[\{T^*_j\}^2\big] + u^2 -2uE_g[T^*_j]
\end{split}
\end{equation}
The posterior expected loss in (\ref{eq : posterior_squared_loss}) attains its minimum at $u = E_g[T^*_j]$, also known as expected time of GR. The posterior expected loss for the absolute loss function is given by:
\begin{equation}
\label{eq : posterior_absolute_loss}
\begin{split}
E_g\big[L\{T^*_j, u\}\big] &= E_g\big[\abs{T^*_j - u}\big]\\
&= \int_u^\infty (T^*_j - u) g(T^*_j)\diff T^*_j + \int_t^u (u - T^*_j) g(T^*_j)\diff T^*_j\\
\end{split}
\end{equation}
The posterior expected loss in (\ref{eq : posterior_absolute_loss}) attains its minimum at the median of $g(T^*_j)$, given by $u = \pi_j^{-1}(0.5 \mid t,s)$, where $\pi_j^{-1}(\cdot)$ is the inverse of dynamic survival probability $\pi_j(u \mid t, s)$ of patient $j$ \citep{rizopoulos2011dynamic}. It is given by:

\begin{equation}
\label{eq : dynamic_surv_prob}
\pi_j(u \mid t, s) = \mbox{Pr}\big\{T^*_j \geq u \mid  T^*_j >t, \mathcal{Y}_j(s), D_n\big\}, u \geq t
\end{equation}
For ease of readability we denote $\pi_j^{-1}(0.5 \mid t,s)$ as $\mbox{median}[T^*_j]$ hereafter.

\subsubsection{Dynamic risk of GR}
\label{subsubsec : dynamic_risk_definitions}
In a practical scenario it is possible that a doctor or a patient may not want to exceed a certain risk $1 - \pi_j(u \mid t, s)$ of GR since the last biopsy. This may be also useful in the cases where variance of $g(T^*_j)$ is high, rendering expected time of GR, or any other measure of central tendency of $g(T^*_j)$ unsuitable. The personalized scheduling approach based on dynamic risk of GR, schedules the next biopsy at a time point $u$ such that the dynamic risk of GR is higher than a certain threshold $1-\kappa,\ \kappa \epsilon [0,1]$ beyond $u$. To this end, the posterior expected loss for the following multilinear loss function can be minimized to find the optimal $u$:

\begin{equation}
\label{eq : loss_dynamic_risk}
L_{k_1, k_2}(T^*_j, u) =
    \begin{cases}
      k_2(T^*_j-u) & \text{if } T^*_j > u\\
      k_1(u-T^*_j) & \text{otherwise}
    \end{cases}       
\end{equation}
where $k_1 > 0$, $k_2 > 0$ are constants parameterizing the loss function. The posterior expected loss function $E_g\big[L_{k_1, k_2}\{T^*_j, u\}\big]$ obtains its minimum at $u = \pi_j^{-1}\big\{k_1/{(k_1 + k_2)} \mid t,s \big\}$ \citep{robertBayesianChoice}. The choice of $k_1, k_2$ is equivalent to the choice of $\kappa$. More specifically, $\kappa = {k_1}/{(k_1 + k_2)}$.

\subsection{A mixed approach between $E_g[T^*_j]$ and dynamic risk of GR}
\label{subsec : mixed_approach}
When the variance $\mbox{var}_g[T^*_j]$ of $g(T^*_j)$ is small, then $E_g[T^*_j]$ as well as $\mbox{median}[T^*_j]$ are practically very useful. However when the variance is large, there may not be a clear central tendency of the distribution. Thus a biopsy scheduled using $E_g[T^*_j]$ or $\mbox{median}[T^*_j]$ will overshoot/undershoot $T^*_j$ by a big margin. In case it undershoots the target time, more biopsies will be required until GR is detected at some time point $T_{j{N_j^b}} >  T^*_j$. In case of overshooting the target, the overshooting margin can be measured as an offset $O_j = T_{j{N_j^b}} - T_j^*$. The maximum acceptable $O_j$ in PRIAS is 3 years, which corresponds to the time gap between biopsies of the PRIAS fixed schedule. When $\mbox{var}_g[T^*_j]$ is large, the proposals based on $E_g[T^*_j]$ or $\mbox{median}[T^*_j]$ can have a large $O_j$. Thus we propose that if the difference between the 0.025 quantile and $E_g[T^*_j]$ or $\mbox{median}[T^*_j]$ is more than 3 years then proposals based on dynamic risk of GR be used instead. We call this approach a mixed approach.

\subsection{Estimation}
\subsubsection{Estimation of $E_g[T^*_j]$ and $\mbox{var}_g[T^*_j]$}
Since there is no closed form solution available for $E_g[T^*_j]$, for its estimation we utilize the following relationship between expected time of GR and dynamic survival probability:

\begin{equation}
\label{eq : expected_time_survprob}
E_g[T^*_j] = t + \int_t^\infty \pi_j(u \mid t, s) \diff u
\end{equation}
There is no closed form solution available for the integral and hence we approximate it using Gauss-Kronrod quadrature. We preferred this approach over Monte Carlo methods to estimate $E_g[T^*_j]$ from the posterior predictive distribution $g(T^*_j)$. This was done because sampling directly from $g(T^*_j)$ involved an additional step of sampling from the distribution $p(T^*_j \mid T^*_j > t, \boldsymbol{b_j}, \boldsymbol{\theta})$, as compared to the estimation of $\pi_j(u \mid t, s)$ \citep{rizopoulos2011dynamic}. Thus the latter approach was computationally faster. As mentioned earlier, a limitation of $E_g[T^*_j]$ is that it is practically useful only when the $\mbox{var}_g[T^*_j]$ is small. The variance is given by:

\begin{equation}
\label{eq : var_time_survprob}
\mbox{var}_g[T^*_j] = 2 \int_t^\infty {(u-t) \pi_j(u \mid t, s) \diff u} - \Big\{\int_t^\infty \pi_j(u \mid t, s) \diff u\Big\}^2
\end{equation}

Since a closed form solution is not available for the variance expression, it is estimated similar to the estimation of $E_g[T^*_j]$. The variance depends both on last biopsy time $t$ and PSA history $\mathcal{Y}_j(s)$. The impact of the observed information on variance is demonstrated in Figure \ref{fig : variance_pred_dist} and discussed in Section \ref{subsec : demo_prias_pers_schedule}.

\subsubsection{Estimation of $\kappa$}
\label{subsubsec : kappa_estimation}
For schedules based on dynamic risk of GR, the value of $\kappa$ dictates the biopsy schedule and thus its choice has important consequences. In certain cases it may be chosen on the basis of doctor's advice or the amount of risk that is acceptable to the patient. For e.g. if maximum acceptable risk is 75\% then $\kappa = 0.25$.\\

In cases where the choice of $k$ cannot be based on the input of the physician or the patients, we propose to automate the choice of this threshold parameter. More specifically, we propose to choose a $\kappa$ for which a binary classification accuracy measure \citep{lopez2014optimalcutpoints,sokolova2009systematic}, discriminating between cases and controls, is maximized. In PRIAS, cases are patients who experience GR and the rest are controls. However, a patient can be in control group at some time $t$ and in the cases at some future time point $t + \Delta t$, and thus time dependent binary classification is more relevant. In joint models, a patient $j$ is predicted to be a case if $\pi_j(t + \Delta t \mid t,s) \leq \kappa$ and a control if $\pi_j(t + \Delta t \mid t,s) > \kappa$ \citep{rizopoulosJMbayes}. The time window $\Delta t$ can be either chosen on a clinical basis, or such that uncertainty in estimation of $\pi_j(t + \Delta t \mid t,s)$ is below a certain threshold or it can even be chosen such that $AUC(t, \Delta t, s)$ \citep{rizopoulosJMbayes} is largest, i.e. $\Delta t$ for which the model has the most discriminative capability at time $t$.\\

To automatically select the threshold $\kappa$, the first binary classification accuracy measure we use is Youden's $J$. It is defined as (the binary classification measures are functions of $t, \Delta t, s$, however the notation is
dropped for readability):
\begin{align*}
J &= \text{TPR} - \text{FPR}, J\epsilon [-1,1],\\
\text{TPR} &= \mbox{Pr}\big\{\pi_j(t + \Delta t \mid t,s) \leq \kappa \mid T^*_j \epsilon (t, t + \Delta t]\big\},\\
\text{FPR} &= \mbox{Pr}\big\{\pi_j(t + \Delta t \mid t,s) > \kappa \mid T^*_j > t + \Delta t \big\}
\end{align*}
where TPR and FPR denote time dependent true positive rate and false positive rate \citep{rizopoulosJMbayes}. The optimal value of $\kappa$ is $\argmax{\kappa} J$. The second binary classification accuracy measure we use is $\text{F}_1$-Score. Unlike Youden's $J$, $F_1$-Score is a measure of classification accuracy for cases only. It is defined as:
\begin{align*}
F_1 &= \frac{2}{\{TPR\}^{-1} + \{PPV\}^{-1}}, F_1 \epsilon [0,1],\\
\text{PPV} &= \mbox{Pr}\big\{T^*_j \epsilon (t, t + \Delta t] \mid \pi_j(t + \Delta t \mid t,s) \leq \kappa \big\}
\end{align*}
where PPV denotes the time dependent positive predictive value. The optimal value of $\kappa$ is $\argmax{\kappa} F_1$.

\subsection{Algorithm}
\label{subsec : pers_sched_algorithm}
Given the personalized scheduling methods, the next step is to iteratively create an entire schedule until GR is detected for the patient. To this end, the algorithm in Figure \ref{fig : sched_algorithm} elucidates the process of creating a personalized schedule for patient $j$. Since PRIAS and most AS programs strongly advise against conducting more than 1 biopsy per year, the algorithm adjusts the optimal time $u$ of biopsy in case the last biopsy was performed less than an year ago.

\begin{figure}
\centering
\captionsetup{justification=centering}
\input{mainmatter/algorithm}
\caption{Algorithm for creating a personalized schedule for patient $j$. $t$ denotes the time of the latest biopsy. $s$ denotes the time of the latest available PSA measurement. $u$ denotes the proposed time of personalized biopsy based on $g(T^*_j)$.  $u^{pv}$ denotes the time at which a repeat biopsy was proposed at the last visit to the hospital. $T^{nv}$ denotes the time of the next visit for PSA measurement.} 
\label{fig : sched_algorithm}
\end{figure}